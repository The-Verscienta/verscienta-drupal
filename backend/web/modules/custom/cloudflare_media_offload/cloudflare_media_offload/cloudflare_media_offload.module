<?php

/**
 * @file
 * Main module file for Cloudflare Media Offload.
 */

use Drupal\Core\Entity\EntityInterface;
use Drupal\Core\Form\FormStateInterface;
use Drupal\Core\Url;
use Drupal\media\MediaInterface;

/**
 * Implements hook_entity_presave().
 */
function cloudflare_media_offload_entity_presave(EntityInterface $entity): void {
  if ($entity instanceof MediaInterface) {
    /** @var \Drupal\cloudflare_media_offload\EventSubscriber\MediaEntitySubscriber $subscriber */
    $subscriber = \Drupal::service('cloudflare_media_offload.media_subscriber');
    $subscriber->onMediaPresave($entity);
  }
}

/**
 * Implements hook_file_url_alter().
 */
function cloudflare_media_offload_file_url_alter(&$uri): void {
  if (str_starts_with($uri, 'cloudflare://')) {
    try {
      /** @var \Drupal\cloudflare_media_offload\Service\CloudflareApiClientInterface $apiClient */
      $apiClient = \Drupal::service('cloudflare_media_offload.api_client');
      $cloudflare_id = str_replace('cloudflare://', '', $uri);
      $uri = $apiClient->getImageUrl($cloudflare_id);
    }
    catch (\Exception $e) {
      // Log the error but don't break the page
      \Drupal::logger('cloudflare_media_offload')->error('Failed to generate Cloudflare URL: @message', [
        '@message' => $e->getMessage(),
      ]);
    }
  }
}

/**
 * Implements hook_image_style_url_alter().
 */
function cloudflare_media_offload_image_style_url_alter(&$path, $style_name): void {
  if (str_starts_with($path, 'cloudflare://')) {
    try {
      /** @var \Drupal\cloudflare_media_offload\Service\CloudflareApiClientInterface $apiClient */
      $apiClient = \Drupal::service('cloudflare_media_offload.api_client');
      $cloudflare_id = str_replace('cloudflare://', '', $path);
      
      // Extract actual image ID from path if it's a style path
      if (strpos($cloudflare_id, 'styles/') === 0) {
        $path_parts = explode('/', $cloudflare_id);
        if (count($path_parts) >= 4) {
          // Path structure: styles/STYLE_NAME/cloudflare/IMAGE_ID
          $cloudflare_id = end($path_parts);
        }
      }
      
      // Get the image style configuration
      $image_style = \Drupal::entityTypeManager()->getStorage('image_style')->load($style_name);
      if (!$image_style) {
        return;
      }
      
      // Convert Drupal image style effects to Cloudflare transformations
      $transformations = _cloudflare_media_offload_convert_style_to_transformations($image_style);
      
      // Generate the transformed URL
      $path = $apiClient->getTransformedImageUrl($cloudflare_id, $transformations);
      
      \Drupal::logger('cloudflare_media_offload')->debug('Generated style URL for @style: @url', [
        '@style' => $style_name,
        '@url' => $path,
      ]);
    }
    catch (\Exception $e) {
      \Drupal::logger('cloudflare_media_offload')->error('Failed to generate Cloudflare style URL for @id: @message', [
        '@id' => $cloudflare_id ?? 'unknown',
        '@message' => $e->getMessage(),
      ]);
    }
  }
}

/**
 * Implements hook_image_style_deliver().
 */
function cloudflare_media_offload_image_style_deliver($style, $scheme): ?bool {
  if ($scheme === 'cloudflare') {
    // For Cloudflare images, we don't need to generate derivatives locally
    // They're handled dynamically via URL transformations
    return TRUE;
  }
  return NULL;
}

/**
 * Implements hook_image_style_flush().
 */
function cloudflare_media_offload_image_style_flush($style): void {
  // Cloudflare handles derivatives dynamically, so no local cleanup needed
  // Just log that a style was flushed for debugging
  \Drupal::logger('cloudflare_media_offload')->debug('Image style @style flushed', [
    '@style' => $style->id(),
  ]);
}

/**
 * Implements hook_file_download_access_alter().
 */
function cloudflare_media_offload_file_download_access_alter(&$grants, array $headers, $request): void {
  $uri = $request->query->get('file');
  
  if ($uri && str_starts_with($uri, 'cloudflare://')) {
    // Allow access to Cloudflare images - they're publicly accessible anyway
    $grants[] = TRUE;
  }
}

/**
 * Implements hook_file_validate().
 */
function cloudflare_media_offload_file_validate($file): array {
  $errors = [];
  
  // If this is a Cloudflare file, skip normal file validation
  if ($file->getFileUri() && str_starts_with($file->getFileUri(), 'cloudflare://')) {
    // Cloudflare files are always considered valid
    return $errors;
  }
  
  return $errors;
}

/**
 * Implements hook_entity_access().
 */
function cloudflare_media_offload_entity_access($entity, $operation, $account): ?\Drupal\Core\Access\AccessResult {
  // Allow access to media entities that use Cloudflare files
  if ($entity->getEntityTypeId() === 'media' && $operation === 'view') {
    $media = $entity;
    $source = $media->getSource();
    
    if ($source && $source->getConfiguration()['source_field']) {
      $source_field_name = $source->getConfiguration()['source_field'];
      if ($media->hasField($source_field_name) && !$media->get($source_field_name)->isEmpty()) {
        $file_entity = $media->get($source_field_name)->entity;
        if ($file_entity && str_starts_with($file_entity->getFileUri(), 'cloudflare://')) {
          return \Drupal\Core\Access\AccessResult::allowed()->addCacheableDependency($entity);
        }
      }
    }
  }
  
  return NULL;
}

/**
 * Implements hook_form_FORM_ID_alter() for media forms.
 */
function cloudflare_media_offload_form_media_form_alter(&$form, FormStateInterface $form_state, $form_id): void {
  $config = \Drupal::config('cloudflare_media_offload.settings');
  $enabled_bundles = $config->get('enabled_bundles') ?? [];
  
  /** @var \Drupal\media\MediaInterface $media */
  $media = $form_state->getFormObject()->getEntity();
  
  if (in_array($media->bundle(), $enabled_bundles)) {
    $form['#attached']['library'][] = 'cloudflare_media_offload/cloudflare_upload';
    
    $form['actions']['submit']['#submit'][] = 'cloudflare_media_offload_media_form_submit';
  }
}

/**
 * Custom submit handler for media forms.
 */
function cloudflare_media_offload_media_form_submit(&$form, FormStateInterface $form_state): void {
  /** @var \Drupal\media\MediaInterface $media */
  $media = $form_state->getFormObject()->getEntity();
  
  \Drupal::messenger()->addStatus(t('Media @label has been uploaded to Cloudflare.', [
    '@label' => $media->label(),
  ]));
}

/**
 * Implements hook_theme().
 */
function cloudflare_media_offload_theme(): array {
  return [
    'cloudflare_bulk_upload' => [
      'variables' => [
        'form' => NULL,
        'results' => [],
      ],
      'template' => 'cloudflare-bulk-upload',
    ],
    'cloudflare_image' => [
      'variables' => [
        'image_url' => NULL,
        'alt' => '',
        'title' => '',
        'attributes' => [],
        'variant' => 'public',
      ],
      'template' => 'cloudflare-image',
    ],
  ];
}

/**
 * Implements hook_help().
 */
function cloudflare_media_offload_help($route_name, $route_match): string {
  switch ($route_name) {
    case 'help.page.cloudflare_media_offload':
      $output = '';
      $output .= '<h3>' . t('About') . '</h3>';
      $output .= '<p>' . t('The Cloudflare Media Offload module provides seamless integration between Drupal\'s Media module and Cloudflare Images for offloading image media storage and serving.') . '</p>';
      $output .= '<h3>' . t('Configuration') . '</h3>';
      $output .= '<p>' . t('Configure the module at <a href=":url">Administration > Configuration > Media > Cloudflare Media Offload</a>.', [
        ':url' => Url::fromRoute('cloudflare_media_offload.settings')->toString(),
      ]) . '</p>';
      $output .= '<ul>';
      $output .= '<li>' . t('Set up your Cloudflare API credentials using the Key module') . '</li>';
      $output .= '<li>' . t('Select which media bundles to offload to Cloudflare') . '</li>';
      $output .= '<li>' . t('Configure upload limits and supported formats') . '</li>';
      $output .= '<li>' . t('Enable features like auto-optimization and bulk upload') . '</li>';
      $output .= '</ul>';
      return $output;

    case 'cloudflare_media_offload.settings':
      return '<p>' . t('Configure Cloudflare Media Offload settings, including API credentials and upload preferences.') . '</p>';

    case 'cloudflare_media_offload.bulk_upload':
      return '<p>' . t('Upload multiple images to Cloudflare Images at once using drag-and-drop.') . '</p>';
  }
  
  return '';
}

/**
 * Convert Drupal image style effects to Cloudflare transformations.
 *
 * @param \Drupal\image\ImageStyleInterface $image_style
 *   The image style entity.
 *
 * @return array
 *   Array of transformation parameters for Cloudflare.
 */
function _cloudflare_media_offload_convert_style_to_transformations($image_style): array {
  $transformations = [];
  
  foreach ($image_style->getEffects() as $effect) {
    $plugin_id = $effect->getPluginId();
    $configuration = $effect->getConfiguration();
    
    switch ($plugin_id) {
      case 'image_resize':
        if (!empty($configuration['data']['width'])) {
          $transformations['width'] = (int) $configuration['data']['width'];
        }
        if (!empty($configuration['data']['height'])) {
          $transformations['height'] = (int) $configuration['data']['height'];
        }
        $transformations['fit'] = 'scale-down';
        break;
        
      case 'image_scale':
        if (!empty($configuration['data']['width'])) {
          $transformations['width'] = (int) $configuration['data']['width'];
        }
        if (!empty($configuration['data']['height'])) {
          $transformations['height'] = (int) $configuration['data']['height'];
        }
        $transformations['fit'] = 'scale-down';
        break;
        
      case 'image_scale_and_crop':
        if (!empty($configuration['data']['width'])) {
          $transformations['width'] = (int) $configuration['data']['width'];
        }
        if (!empty($configuration['data']['height'])) {
          $transformations['height'] = (int) $configuration['data']['height'];
        }
        $transformations['fit'] = 'crop';
        $transformations['gravity'] = 'center';
        break;
        
      case 'image_crop':
        if (!empty($configuration['data']['width'])) {
          $transformations['width'] = (int) $configuration['data']['width'];
        }
        if (!empty($configuration['data']['height'])) {
          $transformations['height'] = (int) $configuration['data']['height'];
        }
        $transformations['fit'] = 'crop';
        
        // Handle anchor positioning for gravity
        $anchor = $configuration['data']['anchor'] ?? 'center-center';
        $gravity_map = [
          'left-top' => 'top-left',
          'center-top' => 'top',
          'right-top' => 'top-right',
          'left-center' => 'left',
          'center-center' => 'center',
          'right-center' => 'right',
          'left-bottom' => 'bottom-left',
          'center-bottom' => 'bottom',
          'right-bottom' => 'bottom-right',
        ];
        $transformations['gravity'] = $gravity_map[$anchor] ?? 'center';
        break;
        
      case 'image_convert':
        // Map Drupal image formats to Cloudflare formats
        $format_map = [
          'jpg' => 'jpeg',
          'jpeg' => 'jpeg',
          'png' => 'png',
          'webp' => 'webp',
        ];
        $extension = strtolower($configuration['data']['extension'] ?? '');
        if (isset($format_map[$extension])) {
          $transformations['format'] = $format_map[$extension];
        }
        break;
    }
  }
  
  // Set default quality for JPEG images
  if (!isset($transformations['quality']) && 
      (!isset($transformations['format']) || $transformations['format'] === 'jpeg')) {
    $transformations['quality'] = 85;
  }
  
  return $transformations;
}

