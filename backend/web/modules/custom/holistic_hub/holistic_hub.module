<?php

/**
 * @file
 * Contains holistic_hub.module.
 *
 * Custom module for Verscienta Health with geocoding and other functionality.
 */

use Drupal\Core\Entity\EntityInterface;
use Drupal\node\NodeInterface;

/**
 * Implements hook_entity_presave().
 *
 * Geocode practitioner and clinic addresses using OpenStreetMap Nominatim API.
 */
function holistic_hub_entity_presave(EntityInterface $entity) {
  // Only process practitioner and clinic nodes.
  if ($entity instanceof NodeInterface && in_array($entity->bundle(), ['practitioner', 'clinic'])) {
    // Check if address fields exist and geocoding hasn't been done.
    if ($entity->hasField('field_address') && !$entity->get('field_address')->isEmpty()) {
      // Build full address from available fields.
      $parts = [];
      $parts[] = $entity->get('field_address')->value;
      if ($entity->hasField('field_city') && !$entity->get('field_city')->isEmpty()) {
        $parts[] = $entity->get('field_city')->value;
      }
      if ($entity->hasField('field_state') && !$entity->get('field_state')->isEmpty()) {
        $parts[] = $entity->get('field_state')->value;
      }
      if ($entity->hasField('field_zip') && !$entity->get('field_zip')->isEmpty()) {
        $parts[] = $entity->get('field_zip')->value;
      }
      $address = implode(', ', $parts);

      // Geocode the address if latitude/longitude fields are empty.
      if ($entity->hasField('field_latitude') && $entity->hasField('field_longitude')) {
        if ($entity->get('field_latitude')->isEmpty() || $entity->get('field_longitude')->isEmpty()) {
          $coordinates = holistic_hub_geocode_address($address);

          if ($coordinates) {
            $entity->set('field_latitude', $coordinates['lat']);
            $entity->set('field_longitude', $coordinates['lon']);
          }
        }
      }
    }
  }
}

/**
 * Geocode an address using OpenStreetMap Nominatim API.
 *
 * @param string $address
 *   The address to geocode.
 *
 * @return array|null
 *   Array with 'lat' and 'lon' keys, or NULL on failure.
 */
function holistic_hub_geocode_address($address) {
  $http_client = \Drupal::httpClient();

  try {
    $url = 'https://nominatim.openstreetmap.org/search';
    $response = $http_client->get($url, [
      'query' => [
        'q' => $address,
        'format' => 'json',
        'limit' => 1,
      ],
      'headers' => [
        'User-Agent' => 'Verscienta Health Application',
      ],
    ]);

    $data = json_decode($response->getBody(), TRUE);

    if (!empty($data[0]['lat']) && !empty($data[0]['lon'])) {
      return [
        'lat' => $data[0]['lat'],
        'lon' => $data[0]['lon'],
      ];
    }
  }
  catch (\Exception $e) {
    \Drupal::logger('holistic_hub')->error('Geocoding failed: @message', [
      '@message' => $e->getMessage(),
    ]);
  }

  return NULL;
}

/**
 * Implements hook_help().
 */
function holistic_hub_help($route_name, $route_match) {
  switch ($route_name) {
    case 'help.page.holistic_hub':
      return '<p>' . t('Custom module for Verscienta Health with geocoding and other custom functionality.') . '</p>';
  }
}