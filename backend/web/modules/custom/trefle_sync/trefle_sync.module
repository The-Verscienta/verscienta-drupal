<?php

/**
 * @file
 * Primary module hooks for Trefle Sync module.
 */

declare(strict_types=1);

use Drupal\Core\Routing\RouteMatchInterface;

/**
 * Implements hook_help().
 */
function trefle_sync_help(string $route_name, RouteMatchInterface $route_match): ?string {
  switch ($route_name) {
    case 'help.page.trefle_sync':
      $output = '<h3>' . t('About') . '</h3>';
      $output .= '<p>' . t('The Trefle Sync module integrates with the Trefle.io botanical API to import plant data into the Herb content type.') . '</p>';
      $output .= '<h3>' . t('Configuration') . '</h3>';
      $output .= '<p>' . t('Configure the module at <a href=":url">Configuration > Web services > Trefle Sync</a>.', [':url' => '/admin/config/services/trefle-sync']) . '</p>';
      $output .= '<h3>' . t('Usage') . '</h3>';
      $output .= '<ul>';
      $output .= '<li>' . t('Search and import plants via the admin UI at <a href=":url">Content > Trefle Sync</a>.', [':url' => '/admin/content/trefle-sync/search']) . '</li>';
      $output .= '<li>' . t('Use Drush commands: <code>drush trefle:search</code>, <code>drush trefle:import</code>, <code>drush trefle:batch-import</code>, <code>drush trefle:stats</code>') . '</li>';
      $output .= '<li>' . t('Enable automatic sync in settings to import plants via cron.') . '</li>';
      $output .= '</ul>';
      return $output;

    default:
      return NULL;
  }
}

/**
 * Implements hook_cron().
 */
function trefle_sync_cron(): void {
  $config = \Drupal::config('trefle_sync.settings');

  // Check if cron sync is enabled.
  if (!$config->get('cron_enabled')) {
    return;
  }

  // Check if API key is configured.
  if (empty($config->get('api_key_id'))) {
    \Drupal::logger('trefle_sync')->warning('Cron sync enabled but no API key configured.');
    return;
  }

  $itemsPerRun = $config->get('cron_items_per_run') ?: 10;
  $currentPage = $config->get('cron_current_page') ?: 1;
  $totalPages = $config->get('cron_total_pages') ?: 0;

  // If total_pages is set and we've exceeded it, stop syncing.
  if ($totalPages > 0 && $currentPage > $totalPages) {
    \Drupal::logger('trefle_sync')->info('Cron sync completed all @pages pages.', ['@pages' => $totalPages]);
    return;
  }

  try {
    /** @var \Drupal\trefle_sync\TrefleSyncServiceInterface $trefleSyncService */
    $trefleSyncService = \Drupal::service('trefle_sync.service');

    // Fetch plants from the current page.
    $response = $trefleSyncService->getPlants($currentPage);
    $plants = $response['data'] ?? [];

    if (empty($plants)) {
      \Drupal::logger('trefle_sync')->info('Cron sync: No more plants to import at page @page.', ['@page' => $currentPage]);
      return;
    }

    // Queue plants for import.
    $queue = \Drupal::queue('trefle_sync_import');
    $queued = 0;

    foreach ($plants as $plant) {
      if ($queued >= $itemsPerRun) {
        break;
      }

      // Check if this plant should be imported based on filters.
      if (!$trefleSyncService->hasNutritionalOrMedicinalBenefits($plant)) {
        continue;
      }

      $queue->createItem([
        'trefle_id' => $plant['id'],
        'common_name' => $plant['common_name'] ?? '',
        'scientific_name' => $plant['scientific_name'] ?? '',
      ]);
      $queued++;
    }

    // Update current page for next cron run.
    \Drupal::configFactory()->getEditable('trefle_sync.settings')
      ->set('cron_current_page', $currentPage + 1)
      ->save();

    \Drupal::logger('trefle_sync')->info('Cron sync: Queued @count plants from page @page.', [
      '@count' => $queued,
      '@page' => $currentPage,
    ]);
  }
  catch (\Exception $e) {
    \Drupal::logger('trefle_sync')->error('Cron sync error: @message', ['@message' => $e->getMessage()]);
  }
}
